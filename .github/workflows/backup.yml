name: Supabase Backup

on:
  schedule:
    # 3 AM y 3 PM CDMX â†’ 9:00 y 21:00 UTC
    - cron: "0 9,21 * * *"
  workflow_dispatch:      # Permite correrlo manualmente

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Install PostgreSQL 17 client
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release

          # Descargar y guardar la llave GPG de PostgreSQL
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /usr/share/keyrings/pgdg.gpg

          # Agregar el repositorio oficial de PostgreSQL usando la llave
          echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list

          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Run pg_dump using Session Pooler
        run: |
          DATE=$(date +"%Y-%m-%d_%H-%M-%S")
          FILE="supabase_backup_$DATE.sql"
          PGPASSWORD=${{ secrets.DB_PASSWORD }} pg_dump \
            -h ${{ secrets.DB_HOST }} \
            -U ${{ secrets.DB_USER }} \
            -d ${{ secrets.DB_NAME }} \
            -p 5432 \
            --no-owner --no-privileges > "$FILE"
          echo "Backup saved to $FILE"
          echo "BACKUP_FILE=$FILE" >> $GITHUB_ENV

      - name: Upload artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup
          path: "*.sql"
          retention-days: 30

